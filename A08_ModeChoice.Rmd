---
title: "Oklahoma City Mode Choice"
author: "Gabriel Barrett-Jackson, Matt Khinda, Samantha Page"
date: "3/30/2023"
output:
  html_document:
    theme: cerulean
    toc: true
    toc_depth: 6
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r libraries}
if (!require(here)) install.packages("here"); library(here)
if (!require(tidyverse)) install.packages("tidyverse"); library(tidyverse)
if (!require(knitr)) install.packages("knitr"); library(knitr)
if (!require(kableExtra)) install.packages("kableExtra"); library(kableExtra)
if (!require(sf)) install.packages("sf"); library(sf)
if (!require(geojsonio)) install.packages("geojsonio"); library(geojsonio)
if (!require(geojsonsf)) install.packages("geojsonsf"); library(geojsonsf)
if (!require(survey)) install.packages("survey"); library(survey)
if (!require(srvyr)) install.packages("srvyr"); library(srvyr)
if (!require(reshape2)) install.packages("reshape2"); library(reshape2)
if (!require(metR)) install.packages("metR"); library(metR)
if (!require(ggnewscale)) install.packages("ggnewscale"); library(ggnewscale)
```


```{r load data}
IRS_mileage_rate <- 0.655

# load travel matrix and geom
full_travel_matrix <- read_csv("full_travel_matrix.csv")
tract_centroid_geom <- geojson_sf("full_centroid_geom.geojson")
tract_flows <- read_csv("tract_flows.csv")
tract_trip_info <- geojson_sf("tract_trip_info.geojson")

getDist <- function(from, to){
  origin = tract_centroid_geom$geometry[tract_centroid_geom$GEOID == from]
  dest = tract_centroid_geom$geometry[tract_centroid_geom$GEOID == to]
  st_distance(x = origin, y = dest)*0.000621371 # convert meters to miles
}

# DO NOT RERUN (takes 1h+) — calculated distance between centroids

#full_travel_matrix <- full_travel_matrix %>%
  #rowwise() %>%
  #mutate(drive_miles = units::drop_units(getDist(from_GEOID, to_GEOID))[1])

# calcuilate drive costs by mile using IRS rate
full_travel_matrix <- full_travel_matrix %>%
  mutate(drive_cost = drive_miles*IRS_mileage_rate)

# split costs for carpool
full_travel_matrix <- full_travel_matrix %>%
  mutate(carpool_cost_hbo = drive_cost / 2.71,
         carpool_cost_hbw = drive_cost / 2.42,
         carpool_cost_nhb = drive_cost / 2.75)

#join flows to ttmatrix
full_travel_matrix <- full_travel_matrix %>%
  left_join(tract_flows)

```


# Calculating Travel Cost

To calculate the driving cost of each trip, we estimated the straight-line distance between the origin and destination centroids, converted that distance to miles, and then used the 2023 IRS mileage reimbursement rate (0.655 dollars) to calculate the cost. The most expensive trip is about $60 to cover 91.4 miles, while the shortest trip is about 0.13 dollars to cover 0.2 miles. 

We acknowledge that this is a rough approximation because it uses “as the crow flies” distance, rather than the shortest path traveled along the roadway between two centroids. We decided to take this approach because we believe that the IRS mileage rate more fully captures the cost of driving than using NHTS data to approximate cost by minute based on fuel expenses, even with this distance limitation. Equally, in the future, this method could be updated using more accurate distances along the road network. 

For HOV trips, we established carpool costs using the “Carpool 2+ only—daily” assumptions from NCHRP 716, which divides the previously calculated driving cost by an average number of additional passengers. 

For cost per transit trip, we had already included a transit fare when we initially created our network and skim. As an estimated average of the Embark system’s different fares, we assigned each trip a $2.00 fare with free transfers. 


```{r write csv}
# output new csv with distance info
#write_csv(full_travel_matrix, "full_travel_matrix.csv")
```

```{r load nhts}
nhts_path <- unzip("../Travel-Forecasting/nhts_data.zip")
# To access specific files use [i]
# [1] ./hhpub.csv
# [2] ./perpub.csv
# [3] ./trippub.csv
# [4] ./vehpub.csv
# [5] ./Citation.docx

okc_nhts_trips <- here(nhts_path[3]) %>%
  read_csv() %>%
  filter(HH_CBSA == "36420") %>%
  filter(TRPTRANS != "01" & # Walk
           TRPTRANS != "02" & # Bike
           TRPTRANS != "19") %>%
  mutate(home_based = (WHYFROM == "01" |
                         WHYFROM == "02" |
                         WHYTO == "01" |
                         WHYTO == "02"),
         work = (WHYFROM == "03" |
           WHYTO == "03")) %>%
  mutate(purpose = case_when(home_based & work ~ "HBW",
                             home_based ~ "HBO",
                             TRUE ~ "NHB")) %>%
  mutate(mode = case_when(TRPTRANS == "03" & NUMONTRP > 1 ~ "HOV",
                          TRPTRANS == "04" & NUMONTRP > 1 ~ "HOV",
                          TRPTRANS == "05" & NUMONTRP > 1 ~ "HOV",
                          TRPTRANS == "06" & NUMONTRP > 1 ~ "HOV",
                          TRPTRANS == "08" & NUMONTRP > 1 ~ "HOV",
                          TRPTRANS == "17" & NUMONTRP > 1 ~ "HOV",
                          TRPTRANS == "18" & NUMONTRP > 1 ~ "HOV",
                          TRPTRANS == "03" ~ "SOV",
                          TRPTRANS == "04" ~ "SOV",
                          TRPTRANS == "05" ~ "SOV",
                          TRPTRANS == "06" ~ "SOV",
                          TRPTRANS == "08" ~ "SOV",
                          TRPTRANS == "17" ~ "SOV",
                          TRPTRANS == "18" ~ "SOV",
                          TRPTRANS == "10" ~ "transit",
                          TRPTRANS == "11" ~ "transit",
                          TRPTRANS == "12" ~ "transit",
                          TRPTRANS == "13" ~ "transit",
                          TRPTRANS == "16" ~ "transit",
                          TRUE ~ "other")) %>%
  filter(mode != "other")
```

```{r nhtsdata}
trips_svy <- okc_nhts_trips %>%
  as_survey(weights = WTTRDFIN)

mode_by_purpose <- trips_svy %>%
  group_by(purpose, mode) %>%
  survey_tally() %>%
  select(-n_se) %>%
  pivot_wider(names_from = mode,
              values_from = n,
              names_prefix = "n_",) %>%
  replace_na(list(n_transit = 0)) %>%
  mutate(n_trips = n_SOV + n_HOV + n_transit) %>%
  mutate(pct_SOV = n_SOV / n_trips) %>%
  mutate(pct_HOV = n_HOV / n_trips) %>%
  mutate(pct_transit = n_transit / n_trips) %>%
  select(purpose, pct_SOV, pct_HOV, pct_transit)
```


# Mode-by-Purpose Table

In setting up the mode-by-purpose table, we noted the overwhelming share of home-based work trips that rely on single-occupancy vehicles (90 percent).


```{r mode by purpose}
kable(mode_by_purpose)
```


```{r constant calcs}

# HBO Model
SOV_share_HBO <- 
  mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "HBO"]

HOV_share_HBO <- 
  mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "HBO"]

transit_share_HBO <- 
  mode_by_purpose$pct_transit[mode_by_purpose$purpose == "HBO"]




#  HBW Model
SOV_share_HBW <- 
  mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "HBW"]

HOV_share_HBW <- 
  mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "HBW"]

transit_share_HBW <- 
  mode_by_purpose$pct_transit[mode_by_purpose$purpose == "HBW"]


#  NHB Model
SOV_share_NHB <- 
  mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "NHB"]

HOV_share_NHB <- 
  mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "NHB"]

transit_share_NHB <- 
  mode_by_purpose$pct_transit[mode_by_purpose$purpose == "NHB"]


# CONSTANTS
SOV_const_HBO <- log(SOV_share_HBO / (1 - SOV_share_HBO)) 
HOV_const_HBO <- log(HOV_share_HBO / (1 - HOV_share_HBO))
transit_const_HBO <- log(transit_share_HBO / (1 - transit_share_HBO))

SOV_const_HBW <- log(SOV_share_HBW / (1 - SOV_share_HBW))
HOV_const_HBW <- log(HOV_share_HBW / (1 - HOV_share_HBW))
transit_const_HBW <- log(transit_share_HBW / (1 - transit_share_HBW))

SOV_const_NHB <- log(SOV_share_NHB / (1 - SOV_share_NHB))
HOV_const_NHB <- log(HOV_share_NHB / (1 - HOV_share_NHB))
transit_const_NHB <- log(transit_share_NHB / (1 - transit_share_NHB))


```


## Model Coefficients

When choosing our model coefficients for each trip purpose, we opted not to choose a nested logit model to maintain consistency across all models. At the outset, we did not think it would fundamentally make a difference in our calculations because we posit that people treat driving alone and in a shared car as a distinct choice. Ultimately, though, we do acknowledge that this choice overweights the probability of people driving by assuming that travelers view driving alone and driving with someone else as entirely distinct choices from one another, providing them with two auto-based options to the single transit option.

For all three trip purposes, we selected a model based on its ability to appropriately fit our study area in the following ways:

* More than 1 million people 
* Excluding non-motorized modes of travel (walking and biking) 
* Including auto submodes (driving alone and sharing a ride)  
* Excluding transit submodes

For home-based other trips, we selected model G. For home-based work trips, we selected model B. And for non-home-based trips, we selected model D. All model parameters and values can be found in NCHRP 716 (tables 4.7 – 4.14). 


```{r utility model}
# Calculate utility of HBO trips (G model coef)
full_travel_matrix <- full_travel_matrix %>%
  mutate(utility_transit_HBO = transit_const_HBO +
                               ivtt * -0.010  +
                               ovtt * -0.046 +
                               fare * -0.029,
         utility_SOV_HBO = SOV_const_HBO +
                           drive_time * -0.010 +
                           drive_cost * -0.029,
         utility_HOV_HBO = HOV_const_HBO +
                           drive_time * -0.010 +
                           carpool_cost_hbo * -0.029) %>%
  mutate(exp_u_SOV_HBO = exp(utility_SOV_HBO),
         exp_u_HOV_HBO = exp(utility_HOV_HBO),
         exp_u_transit_HBO = exp(utility_transit_HBO)) %>%
  rowwise() %>%
  mutate(total_utility_HBO = sum(exp_u_SOV_HBO,
                                 exp_u_HOV_HBO,
                                 exp_u_transit_HBO,
                                 na.rm = TRUE)) %>%
  ungroup()

# Calculate utility of HBW trips (B model coef)
full_travel_matrix <- full_travel_matrix %>%
  mutate(utility_transit_HBW = transit_const_HBW +
                               ivtt * -0.030  +
                               ovtt * -0.075 +
                               fare * -0.0043,
         utility_SOV_HBW = SOV_const_HBW +
                           drive_time * -0.030 +
                           drive_cost * -0.0043,
         utility_HOV_HBW = HOV_const_HBW +
                           drive_time * -0.030 +
                           carpool_cost_hbw * -0.0043) %>%
  mutate(exp_u_SOV_HBW = exp(utility_SOV_HBW),
         exp_u_HOV_HBW = exp(utility_HOV_HBW),
         exp_u_transit_HBW = exp(utility_transit_HBW)) %>%
  rowwise() %>%
  mutate(total_utility_HBW = sum(exp_u_SOV_HBW,
                                 exp_u_HOV_HBW,
                                 exp_u_transit_HBW,
                                 na.rm = TRUE)) %>%
  ungroup()

# Calculate utility of NHB trips (D model coef)
full_travel_matrix <- full_travel_matrix %>%
  mutate(utility_transit_NHB = transit_const_NHB +
                               ivtt * -0.011  +
                               (access_wt + egress_wt) * -0.066 +
                               init_wt * -0.061 +
                               transfer_wt * -0.059 +
                               fare * -0.033,
         utility_SOV_NHB = SOV_const_NHB +
                           drive_time * -0.011 +
                           drive_cost * -0.033,
         utility_HOV_NHB = HOV_const_NHB +
                           drive_time * -0.011 +
                           carpool_cost_nhb * -0.033) %>%
  mutate(exp_u_SOV_NHB = exp(utility_SOV_NHB),
         exp_u_HOV_NHB = exp(utility_HOV_NHB),
         exp_u_transit_NHB = exp(utility_transit_NHB)) %>%
  rowwise() %>%
  mutate(total_utility_NHB = sum(exp_u_SOV_NHB,
                                 exp_u_HOV_NHB,
                                 exp_u_transit_NHB,
                                 na.rm = TRUE)) %>%
  ungroup()

```

```{r probability mode share}
# determine mode share for HBO
full_travel_matrix <- full_travel_matrix %>%
  mutate(p_transit_HBO = exp(utility_transit_HBO) / total_utility_HBO,
         p_SOV_HBO = exp(utility_SOV_HBO) / total_utility_HBO,
         p_HOV_HBO = exp(utility_HOV_HBO) / total_utility_HBO) %>%
  replace_na(list(p_transit_HBO = 0,
                  p_SOV_HBO = 0,
                  p_HOV_HBO = 0))

# determine mode share for HBW
full_travel_matrix <- full_travel_matrix %>%
  mutate(p_transit_HBW = exp(utility_transit_HBW) / total_utility_HBW,
         p_SOV_HBW = exp(utility_SOV_HBW) / total_utility_HBW,
         p_HOV_HBW = exp(utility_HOV_HBW) / total_utility_HBW) %>%
  replace_na(list(p_transit_HBW = 0,
                  p_SOV_HBW = 0,
                  p_HOV_HBW = 0))

# determine mode share for NHB
full_travel_matrix <- full_travel_matrix %>%
  mutate(p_transit_NHB = exp(utility_transit_NHB) / total_utility_NHB,
         p_SOV_NHB = exp(utility_SOV_NHB) / total_utility_NHB,
         p_HOV_NHB = exp(utility_HOV_NHB) / total_utility_NHB) %>%
  replace_na(list(p_transit_NHB = 0,
                  p_SOV_NHB = 0,
                  p_HOV_NHB = 0))
```

```{r assign trips, include = FALSE}

full_travel_matrix <- full_travel_matrix %>%
  mutate(n_transit_HBO = round(HBO_flow * p_transit_HBO),
         n_SOV_HBO = round(HBO_flow * p_SOV_HBO),
         n_HOV_HBO = round(HBO_flow * p_HOV_HBO),
         n_transit_HBW = round(HBW_flow * p_transit_HBW),
         n_SOV_HBW = round(HBW_flow * p_SOV_HBW),
         n_HOV_HBW = round(HBW_flow * p_HOV_HBW),
         n_transit_NHB = round(NHB_flow * p_transit_NHB),
         n_SOV_NHB = round(NHB_flow * p_SOV_NHB),
         n_HOV_NHB = round(NHB_flow * p_HOV_NHB)) %>%
  replace_na(list(n_transit_HBO = 0,
                  n_SOV_HBO = 0,
                  n_HOV_HBO = 0,
                  n_transit_HBW = 0,
                  n_SOV_HBW = 0,
                  n_HOV_HBW = 0,
                  n_transit_NHB = 0,
                  n_SOV_NHB = 0,
                  n_HOV_NHB = 0)) 

full_travel_matrix %>%
  select(from_GEOID,
         to_GEOID,
         n_transit_HBO,
         n_SOV_HBO,
         n_HOV_HBO,
         n_transit_HBW,
         n_SOV_HBW,
         n_HOV_HBW,
         n_transit_NHB,
         n_SOV_NHB,
         n_HOV_NHB)
```


# Calibration

Through trial and error, we learned the nuances of balancing out coefficients across the different modes within each trip type. We aimed to be within a 5 percentage point threshold from the observed mode share by purpose data from the NHTS. 

As initial values, all constants were set to the log odds of that particular mode for that purpose from the NHTS. If the resulting predicted value was above or below the accuracy threshold, the values were adjusted manually until the result was satisfactorily close.  

HBO: For SOV kept the coefficient at -0.28; we changed the coefficient for HOV from 0.167 to -0.25; and for transit we kept the coefficient at -3.52.
HBW: For SOV we went from 2.26 to 0.70; HOV -2.56 to -2.00; transit -3.74 to -1.00
NHB: All mode shares were within 2 percentage points of the NHTS data shares, so we did not change the coefficients.


### Comparison Between NHTS Data and Model 1


```{r compare model to nhts}

modeled_mode_by_purpose_1 <- tibble(
  purpose = c("HBO_model_1", "HBW_model_1", "NHB_model_1"), 
  pct_transit = c(sum(full_travel_matrix$n_transit_HBO) / 
                   sum(full_travel_matrix$HBO_flow),
                 sum(full_travel_matrix$n_transit_HBW) / 
                   sum(full_travel_matrix$HBW_flow),
                sum(full_travel_matrix$n_transit_NHB) / 
                   sum(full_travel_matrix$NHB_flow)),
  pct_SOV = c(sum(full_travel_matrix$n_SOV_HBO) / 
                sum(full_travel_matrix$HBO_flow),
              sum(full_travel_matrix$n_SOV_HBW) / 
                sum(full_travel_matrix$HBW_flow),
              sum(full_travel_matrix$n_SOV_NHB) / 
                   sum(full_travel_matrix$NHB_flow)),
  pct_HOV = c(sum(full_travel_matrix$n_HOV_HBO) / 
                sum(full_travel_matrix$HBO_flow),
              sum(full_travel_matrix$n_HOV_HBW) / 
                sum(full_travel_matrix$HBW_flow),
              sum(full_travel_matrix$n_HOV_NHB) / 
                   sum(full_travel_matrix$NHB_flow)))

model_compare <- rbind(mode_by_purpose, modeled_mode_by_purpose_1) %>%
  arrange(purpose)

kable(model_compare)
```


```{r model_2}

# CONSTANTS
SOV_const_HBO <- log(SOV_share_HBO / (1 - SOV_share_HBO)) 
HOV_const_HBO <- -.25
transit_const_HBO <- log(transit_share_HBO / (1 - transit_share_HBO))

SOV_const_HBW <- 0.7
HOV_const_HBW <- -2
transit_const_HBW <- -1 

SOV_const_NHB <- log(SOV_share_NHB / (1 - SOV_share_NHB))
HOV_const_NHB <- log(HOV_share_NHB / (1 - HOV_share_NHB))
transit_const_NHB <- log(transit_share_NHB / (1 - transit_share_NHB))

# HBO Model
SOV_share_HBO <- 
  mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "HBO"]

HOV_share_HBO <- 
  mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "HBO"]

transit_share_HBO <- 
  mode_by_purpose$pct_transit[mode_by_purpose$purpose == "HBO"]




#  HBW Model
SOV_share_HBW <- 
  mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "HBW"]

HOV_share_HBW <- 
  mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "HBW"]

transit_share_HBW <- 
  mode_by_purpose$pct_transit[mode_by_purpose$purpose == "HBW"]


#  NHB Model
SOV_share_NHB <- 
  mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "NHB"]

HOV_share_NHB <- 
  mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "NHB"]

transit_share_NHB <- 
  mode_by_purpose$pct_transit[mode_by_purpose$purpose == "NHB"]




```


```{r utility model 2}
# Calculate utility of HBO trips (G model coef)
full_travel_matrix <- full_travel_matrix %>%
  mutate(utility_transit_HBO = transit_const_HBO +
                               ivtt * -0.010  +
                               ovtt * -0.046 +
                               fare * -0.029,
         utility_SOV_HBO = SOV_const_HBO +
                           drive_time * -0.010 +
                           drive_cost * -0.029,
         utility_HOV_HBO = HOV_const_HBO +
                           drive_time * -0.010 +
                           carpool_cost_hbo * -0.029) %>%
  mutate(exp_u_SOV_HBO = exp(utility_SOV_HBO),
         exp_u_HOV_HBO = exp(utility_HOV_HBO),
         exp_u_transit_HBO = exp(utility_transit_HBO)) %>%
  rowwise() %>%
  mutate(total_utility_HBO = sum(exp_u_SOV_HBO,
                                 exp_u_HOV_HBO,
                                 exp_u_transit_HBO,
                                 na.rm = TRUE)) %>%
  ungroup()

# Calculate utility of HBW trips (B model coef)
full_travel_matrix <- full_travel_matrix %>%
  mutate(utility_transit_HBW = transit_const_HBW +
                               ivtt * -0.030  +
                               ovtt * -0.075 +
                               fare * -0.0043,
         utility_SOV_HBW = SOV_const_HBW +
                           drive_time * -0.030 +
                           drive_cost * -0.0043,
         utility_HOV_HBW = HOV_const_HBW +
                           drive_time * -0.030 +
                           carpool_cost_hbw * -0.0043) %>%
  mutate(exp_u_SOV_HBW = exp(utility_SOV_HBW),
         exp_u_HOV_HBW = exp(utility_HOV_HBW),
         exp_u_transit_HBW = exp(utility_transit_HBW)) %>%
  rowwise() %>%
  mutate(total_utility_HBW = sum(exp_u_SOV_HBW,
                                 exp_u_HOV_HBW,
                                 exp_u_transit_HBW,
                                 na.rm = TRUE)) %>%
  ungroup()

# Calculate utility of NHB trips (D model coef)
full_travel_matrix <- full_travel_matrix %>%
  mutate(utility_transit_NHB = transit_const_NHB +
                               ivtt * -0.011  +
                               (access_wt + egress_wt) * -0.066 +
                               init_wt * -0.061 +
                               transfer_wt * -0.059 +
                               fare * -0.033,
         utility_SOV_NHB = SOV_const_NHB +
                           drive_time * -0.011 +
                           drive_cost * -0.033,
         utility_HOV_NHB = HOV_const_NHB +
                           drive_time * -0.011 +
                           carpool_cost_nhb * -0.033) %>%
  mutate(exp_u_SOV_NHB = exp(utility_SOV_NHB),
         exp_u_HOV_NHB = exp(utility_HOV_NHB),
         exp_u_transit_NHB = exp(utility_transit_NHB)) %>%
  rowwise() %>%
  mutate(total_utility_NHB = sum(exp_u_SOV_NHB,
                                 exp_u_HOV_NHB,
                                 exp_u_transit_NHB,
                                 na.rm = TRUE)) %>%
  ungroup()

```

```{r probability mode share 2}
# determine mode share for HBO
full_travel_matrix <- full_travel_matrix %>%
  mutate(p_transit_HBO = exp(utility_transit_HBO) / total_utility_HBO,
         p_SOV_HBO = exp(utility_SOV_HBO) / total_utility_HBO,
         p_HOV_HBO = exp(utility_HOV_HBO) / total_utility_HBO) %>%
  replace_na(list(p_transit_HBO = 0,
                  p_SOV_HBO = 0,
                  p_HOV_HBO = 0))

# determine mode share for HBW
full_travel_matrix <- full_travel_matrix %>%
  mutate(p_transit_HBW = exp(utility_transit_HBW) / total_utility_HBW,
         p_SOV_HBW = exp(utility_SOV_HBW) / total_utility_HBW,
         p_HOV_HBW = exp(utility_HOV_HBW) / total_utility_HBW) %>%
  replace_na(list(p_transit_HBW = 0,
                  p_SOV_HBW = 0,
                  p_HOV_HBW = 0))

# determine mode share for NHB
full_travel_matrix <- full_travel_matrix %>%
  mutate(p_transit_NHB = exp(utility_transit_NHB) / total_utility_NHB,
         p_SOV_NHB = exp(utility_SOV_NHB) / total_utility_NHB,
         p_HOV_NHB = exp(utility_HOV_NHB) / total_utility_NHB) %>%
  replace_na(list(p_transit_NHB = 0,
                  p_SOV_NHB = 0,
                  p_HOV_NHB = 0))
```

```{r assign trips 2, include = FALSE}

full_travel_matrix <- full_travel_matrix %>%
  mutate(n_transit_HBO = round(HBO_flow * p_transit_HBO),
         n_SOV_HBO = round(HBO_flow * p_SOV_HBO),
         n_HOV_HBO = round(HBO_flow * p_HOV_HBO),
         n_transit_HBW = round(HBW_flow * p_transit_HBW),
         n_SOV_HBW = round(HBW_flow * p_SOV_HBW),
         n_HOV_HBW = round(HBW_flow * p_HOV_HBW),
         n_transit_NHB = round(NHB_flow * p_transit_NHB),
         n_SOV_NHB = round(NHB_flow * p_SOV_NHB),
         n_HOV_NHB = round(NHB_flow * p_HOV_NHB)) %>%
  replace_na(list(n_transit_HBO = 0,
                  n_SOV_HBO = 0,
                  n_HOV_HBO = 0,
                  n_transit_HBW = 0,
                  n_SOV_HBW = 0,
                  n_HOV_HBW = 0,
                  n_transit_NHB = 0,
                  n_SOV_NHB = 0,
                  n_HOV_NHB = 0)) 

full_travel_matrix %>%
  select(from_GEOID,
         to_GEOID,
         n_transit_HBO,
         n_SOV_HBO,
         n_HOV_HBO,
         n_transit_HBW,
         n_SOV_HBW,
         n_HOV_HBW,
         n_transit_NHB,
         n_SOV_NHB,
         n_HOV_NHB) 
```


### Comparison Between NHTS Data and Final Model


```{r compare model to nhts 2}

modeled_mode_by_purpose_2 <- tibble(
  purpose = c("HBO_model_2", "HBW_model_2", "NHB_model_2"), 
  pct_transit = c(sum(full_travel_matrix$n_transit_HBO) / 
                   sum(full_travel_matrix$HBO_flow),
                 sum(full_travel_matrix$n_transit_HBW) / 
                   sum(full_travel_matrix$HBW_flow),
                sum(full_travel_matrix$n_transit_NHB) / 
                   sum(full_travel_matrix$NHB_flow)),
  pct_SOV = c(sum(full_travel_matrix$n_SOV_HBO) / 
                sum(full_travel_matrix$HBO_flow),
              sum(full_travel_matrix$n_SOV_HBW) / 
                sum(full_travel_matrix$HBW_flow),
              sum(full_travel_matrix$n_SOV_NHB) / 
                   sum(full_travel_matrix$NHB_flow)),
  pct_HOV = c(sum(full_travel_matrix$n_HOV_HBO) / 
                sum(full_travel_matrix$HBO_flow),
              sum(full_travel_matrix$n_HOV_HBW) / 
                sum(full_travel_matrix$HBW_flow),
              sum(full_travel_matrix$n_HOV_NHB) / 
                   sum(full_travel_matrix$NHB_flow)))

model_compare_2 <- rbind(model_compare, modeled_mode_by_purpose_2) %>%
  arrange(purpose)

kable(model_compare_2)
```


```{r total trip count }
full_travel_matrix <- full_travel_matrix %>%
  rowwise() %>%
  mutate(n_total_total = sum(n_transit_HBO,
                             n_SOV_HBO,
                             n_HOV_HBO,
                             n_transit_HBW,
                             n_SOV_HBW,
                             n_HOV_HBW,
                             n_transit_NHB,
                             n_SOV_NHB,
                             n_HOV_NHB),
           n_transit_total = sum(n_transit_HBO,
                                 n_transit_HBW,
                                 n_transit_NHB),
           n_SOV_total = sum(n_SOV_HBO,
                             n_SOV_HBW,
                             n_SOV_NHB),
           n_HOV_total = sum(n_HOV_HBO,
                             n_HOV_HBW,
                             n_HOV_NHB),
           n_total_HBO = sum(n_transit_HBO,
                               n_SOV_HBO,
                               n_HOV_HBO),
           n_total_HBW = sum(n_transit_HBW,
                               n_SOV_HBW,
                               n_HOV_HBW),
           n_total_NHB = sum(n_transit_NHB,
                               n_SOV_NHB,
                               n_HOV_NHB))
```


# Visualizations

In order to understand the relationship between trip length and mode choice, we plotted the percent of trips using a particular mode (as predicted by our model) against the drive time of that trip. We then further subset the data by purpose to illustrate the difference in mode share for different kinds of trips. 

We used drive time as our preferred metric of travel time based on the same assumption we used in the trip generation and distribution calculation — that it most often will be the shortest trip between two zones. Because there are over 130,000 individual origin-destination pairs in our matrix, we decided to create binned scatter plots which more clearly present the trend by reducing the visual noise. The bins are set at roughly 5-minute intervals in drive time, which was done by taking the max drive time of approximately 425 minutes and dividing it by 5. Within each of these bins, the mean share of each mode for all trips is calculated and presented. 

While we think this approach makes the data more understandable, we acknowledge it comes with some limitations. First, because transit ridership overall is very low and there are many trips for which transit is not an option at all, taking the mean transit share results in a value of nearly 0. While this does reflect a general lack of transit use, it may also falsely give the impression that “no-one rides transit” when there are some origin-destination pairs where transit is significantly more common than others. Also, because a mean value is heavily affected by outliers, it can be a less useful or representative metric for small sample sizes. This comes up in particular for the bins of drive times above 90 minutes for which the number of trips is significantly smaller than, for example, the 5-10 minute bin. 

We notice that at trips of about 45 minutes there is a slight bump in the share of HOV trips and a slight dip in the share of SOV trips. This happens again for trips of about 90 minutes. This plot suggests that it is unlikely for people to carpool for trips of 2+ hours, across all trip purposes. We also note that the bumps happen right around 15-minute intervals, suggesting an effect from people’s tendency to round time into more precise intervals. 

We initially mapped this information to understand the spatial distribution of mode choice throughout our study area, too. However, it seemed repetitive of these scatter plots and did not contribute any new interpretations of our analysis. In particular, because the SOV and HOV mode shares are both approximately 40-55% of mode share for all trips, there was little range across the geography. We wonder if this lack of differentiation is a symptom of not having chosen a nested logit model.


```{r chart mode split}
ggplot()+
  stat_summary_bin(data = full_travel_matrix, aes(x = drive_time, y = (n_transit_total/n_total_total)), color = "red", alpha = 0.5, fun="mean", bins=84, size=2, geom="point") +
  stat_summary_bin(data = full_travel_matrix, aes(x = drive_time, y = (n_SOV_total/n_total_total)), color = "blue", alpha = 0.5, fun="mean", bins=84, size=2, geom="point") +
  stat_summary_bin(data = full_travel_matrix, aes(x = drive_time, y = (n_HOV_total/n_total_total)), color = "goldenrod", alpha = 0.5, fun="mean", bins=84, size=2, geom="point") +
  scale_x_continuous(breaks = seq(from =0, to = 240, by = 30)) +
  labs(title = "Mode Split by Drive Time for all Trip Purposes", x = "Drive Time (mins)", y = "Mode Share (Fraction of Total Trips)") +
  theme_minimal()

# HBO
ggplot()+
  stat_summary_bin(data = full_travel_matrix, aes(x = drive_time, y = (n_transit_HBO/n_total_HBO)), color = "red", alpha = 0.5, fun="mean", bins=84, size=2, geom="point") +
  stat_summary_bin(data = full_travel_matrix, aes(x = drive_time, y = (n_SOV_HBO/n_total_HBO)), color = "blue", alpha = 0.5, fun="mean", bins=84, size=2, geom="point") +
  stat_summary_bin(data = full_travel_matrix, aes(x = drive_time, y = (n_HOV_HBO/n_total_HBO)), color = "goldenrod", alpha = 0.5, fun="mean", bins=84, size=2, geom="point") +
  scale_x_continuous(breaks = seq(from =0, to = 240, by = 30)) +
  labs(title = "Mode Split by Drive Time for Home-Based Other Trips", x = "Drive Time (mins)", y = "Mode Share (Fraction of Total Trips)") +
  theme_minimal()

# HBW
ggplot()+
  stat_summary_bin(data = full_travel_matrix, aes(x = drive_time, y = (n_transit_HBW/n_total_HBW)), color = "red", alpha = 0.5, fun="mean", bins=84, size=2, geom="point") +
  stat_summary_bin(data = full_travel_matrix, aes(x = drive_time, y = (n_SOV_HBW/n_total_HBW)), color = "blue", alpha = 0.5, fun="mean", bins=84, size=2, geom="point") +
  stat_summary_bin(data = full_travel_matrix, aes(x = drive_time, y = (n_HOV_HBW/n_total_HBW)), color = "goldenrod", alpha = 0.5, fun="mean", bins=84, size=2, geom="point") +
  scale_x_continuous(breaks = seq(from =0, to = 240, by = 30)) +
  labs(title = "Mode Split by Drive Time for Home-Based Work Trips", x = "Drive Time (mins)", y = "Mode Share (Fraction of Total Trips)") +
  theme_minimal()

# NHB
ggplot()+
  stat_summary_bin(data = full_travel_matrix, aes(x = drive_time, y = (n_transit_NHB/n_total_NHB)), color = "red", alpha = 0.5, fun="mean", bins=84, size=2, geom="point") +
  stat_summary_bin(data = full_travel_matrix, aes(x = drive_time, y = (n_SOV_NHB/n_total_NHB)), color = "blue", alpha = 0.5, fun="mean", bins=84, size=2, geom="point") +
  stat_summary_bin(data = full_travel_matrix, aes(x = drive_time, y = (n_HOV_NHB/n_total_NHB)), color = "goldenrod", alpha = 0.5, fun="mean", bins=84, size=2, geom="point") +
  scale_x_continuous(breaks = seq(from =0, to = 240, by = 30)) +
  labs(title = "Mode Split by Drive Time for Non Home-Based Trips", x = "Drive Time (mins)", y = "Mode Share (Fraction of Total Trips)") +
  theme_minimal()

```

```{r map}
prob_travel_matrix <- full_travel_matrix %>%
  select(from_GEOID, n_transit_total, n_SOV_total, n_HOV_total, n_total_total) %>%
  mutate(GEOID = as.character(from_GEOID)) %>%
  group_by(GEOID) %>%
  summarise(n_transit_total = sum(n_transit_total), 
            n_total_total = sum(n_total_total),
            n_SOV_total = sum(n_SOV_total),
            n_HOV_total = sum(n_HOV_total)) %>%
  mutate(pct_transit = (n_transit_total/n_total_total),
         pct_SOV = (n_SOV_total/n_total_total),
         pct_HOV = (n_HOV_total/n_total_total)) 
  

transit_prob_tracts <- tract_trip_info %>% 
  select(GEOID, geometry) %>% 
  left_join(prob_travel_matrix) %>%
  mutate(pct_transit = ifelse(pct_transit < 0.00000000001, NA, pct_transit))
```